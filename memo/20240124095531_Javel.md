# Javel

　日本語の小説を書くアプリについて考える。

<!-- more -->

# 要約

　Javelは日本語の小説を書くアプリ群の総称。JapaneseNovel略してJavel。
　書く、印刷・製本する、公開する、読む、といった小説にまつわる作業を簡易化するアプリ群である。
　ユーザが自由に扱えるアプリをめざす。OSSで外部依存を最小限に抑えて実行できること。

名前|目的
----|----
writer|書く
printer|印刷・製本する
publisher|公開する
reader|読む

名前|目的
----|----
desk|自作品を保存するアプリ
shelf|読んだ作品を保存するアプリ
replyer|読者が著者に返信するアプリ（感想、指摘、寄付を保存する）
scopper|他者の作品を紹介するアプリ

# 思想

　誰でも永久無料で自由に執筆・公開できるアプリ。

　既存の小説投稿サイトでは満たせない要件がある。すなわちユーザが自由に書くことだ。頻繁に変わる規約の熟読と遵守、不当な垢BAN、運営元犯罪への間接的加担、運営元の経営都合によるサ終や改悪など。ユーザにとって理不尽かつ不都合を押し付けられる。それらは執筆活動となんら関係ないのに、便利なアプリを使って活動したくば、それらに恭順せねばならない。きわめて苦痛である。

　これらは営利目的であることから生じるトラブルだ。運営元は出版社であり有用な著者を安く徴用して利益をあげたい。そのための小説投稿サイトだ。著者にとってはプロ作家への道であるため、評価システムを使って人気を捏造する等を起こす人もいる。運営はこれに労力をかけず対応したいため、頻繁に誰かを評価する者を無差別にBANする事態が起きる。するとBANを恐れて誰も人の作品を読んで評価しようとする気が起きなくなり、文学業界の発展に歯止めがかかってしまう。読者、著者、運営、それぞれの立場で自分たちの利益を最大化したくて起きてしまう悲劇だ。

　ただただ楽しく書きたい。そのためなら営利目的を犠牲にしてもいい。かといって執筆活動以外のことで勉強や苦労をしたくない。執筆活動に集中したい。そういう趣味人のためのアプリを作りたい。営利でなくそれ自体を楽しむ同人作家の活動を支援するアプリが欲しい。逆にプロ作家や書籍化といったことへの道へは繋がらない。そうした棲み分けを意識してアプリを作りたい。

　最もコストがかかるのは公開である。サーバを運営する必要がある。自力で公開できる／外部に委託する、で別のコードを実行するようにしたい。また、IPFSなどのP2P形式も考慮に入れる。これは両者の中間である。

# 開発方針

　クロスプラットフォームをめざす。PCやスマホなど異なるデバイスでも同じコードで同じように動作するのが理想。

## 課題

1. セキュリティ
2. パフォーマンス
3. 開発コスト

### 1. セキュリティ

　クロスプラットフォームに書くならHTML,CSS,JSによる実装がベスト。だがこれにはセキュリティ問題がある。特にデータ保存に関して。

　盗作される恐れがある。
　JSでは以下の方法でブラウザにデータ保存できる。ただしいずれもJSで取得可能なためXSS攻撃に弱い。よって個人情報や秘密にしておきたいデータはブラウザに一切保存しないことが望ましい。

* Cookie
* LocalStorage/SessionStorage
* IndexedDB

　セキュリティを考慮したら保存が一切できないアプリになってしまう。利便性が著しく落ちて利用価値がない。本末転倒だ。そこで対案をいくつか考える。

対案|問題
----|----
ネイティブアプリ|開発コスト超増大（OSごとに異なるAPIを使うため非現実的）
Electronアプリ|開発コスト増大（Electron固有概念の理解と実装）、PCのみ動作（スマホでは動作しない）
file://プロトコル利用|利便性激減（HTTPS上でのみ使える各種APIが使えない）

　このうちfile://プロトコル利用が最も平易。このとき、さらに次のようなセキュリティと利便性のトレードオフがある。

* ブラウザ保存機構使用の是非
* 秘密情報のハードコーディング
* 毎回ユーザ操作による外部ファイル読書

　上ほどセキュリティが弱く利便性が高い。
　file://プロトコルはブラウザ保存機構を使うためXSS攻撃される恐れがある。オンラインでブラウザ閲覧しているとき、どこかのサイトの悪意あるコードによって盗作される恐れがある。利便性は高くユーザはファイル選択などの操作を強いられない。
　秘密情報をハードコーディングする戦略がある。XSS攻撃を避けられる。ただしそのソースコードファイルごと公開してしまえば自爆になる。取扱に注意を促すべき。
　最も安全なのは毎回ユーザ操作による外部ファイル読書だ。これはあまりに手間であり利便性を損なう。だが単発の作品を作るときには十分候補になる。

　ハードコーディング手法と外部ファイル読書の組み合わせについて考える。つまりユーザにとって使い回しになる著者情報はハードコーディングし、作品は毎回個別になるから外部ファイルとして扱う。
　これを「ファイル規格手法」と仮称する。

　ファイル規格手法は開発コストがやや増大し、利便性もやや下がる。まずユーザはハードコーディングする著者情報を入力する。そしてアプリを動的生成するボタンを押す。以降はその生成されたアプリファイルを実行して作品を書く。
　開発者はアプリを動的生成するアプリも作らねばならない。しかもユーザはもし著者情報が変更したり追加になったら、また動的生成せねばならない。前の生成アプリを配置・上書きするなどのファイル操作が必要になる。

　同一ユーザ内で共有する情報は著者情報である。これは次のようなYAMLファイル形式にできる。JavelWriter生成アプリにこのデータを渡してアプリ生成すれば、これら著者データがハードコーディングされたJavelWriterアプリが生成される。

author.yaml
```
name:
	javel: 山田《やまだ》太郎《たろう》
services:
	github: userName1,
	mastodon:
		instance.one: userName2
		instance.two: userName3
	misskey:
		instance.one: userName4
		instance.two: userName5
cryptos:
	mona: address1
	btc: address2
	ltc: address3
keys:
	publick: xxxxxxxxxxxxxxx
	private: zzzzzzzzzzzzzzz
```

　これに加えてカテゴリやジャンルも自作できると尚良し。さらに小説本文や著者情報などの全メタデータをまるごとテンプレートとして初期値にハードコーディングできれば最高。テキストエディタでも編集しやすくなる。

　複数の著者を扱うときは次のようにもできる。

```
[
	{name:'', services:{github:'',mastodon:{ins1:'user',ins2:'user'}, cryptos:{mona:'addr'}, keys:{pub:'',pri:''}}},
	{name:'', services:{github:'',mastodon:{ins1:'user',ins2:'user'}, cryptos:{mona:'addr'}, keys:{pub:'',pri:''}}},
	{name:'', services:{github:'',mastodon:{ins1:'user',ins2:'user'}, cryptos:{mona:'addr'}, keys:{pub:'',pri:''}}},
]
```

　ハードコーディング手法について。開発コストはやや増大し、利便性もやや下がる。ユーザごとに異なる著者名などをハードコーディングしたい。

　HTML,CSS,JS実装方法をセキュリティが高い順（利便性が低い順）に挙げていく。

1. ファイル規格手法（毎回手動操作による著者情報と作品の外部ファイル読書）
2. ファイル規格手法（秘密情報ハードコーディング＋毎回手動操作による作品の外部ファイル読書）
3. ファイル規格手法（ブラウザ保存機構）
4. HTTPS（ブラウザ保存機構。PWAによる自動更新。Cacheによるオフライン実行。fetch()でWebAPI実行）

### 2. パフォーマンス

　パフォーマンスは実行速度のこと。ふつうクロスプラットフォームであるほど実行速度は遅くなる。ネイティブAPIを使うほど高速になるが開発コストが上がる。

　HTML,CSS,JSに着目する。パフォーマンスにより実装方法は多岐にわたる。たとえばWebAssemblyやWebWorkerAPI。特にWebWorkerAPIでマルチスレッド化することはGUIアプリにおいて重要。だが、これはHTTPS上でないと使えない。ファイル規格手法では使えない。

### 3. 開発コスト

# 総合評価

手法|セキュリティ|パフォーマンス|コスト|可動性|利便性
----|------------|--------------|------|------|------
ネイティブ|高|高|頂|低|頂
Electron|中|低|高|中|高
ブラウザ(HTTPS/保存機構使用)|低|低|高|高|高
ブラウザ(FILE/保存機構使用)|低|低|中|高|中
ブラウザ(FILE/ハードコード)|中|低|中|高|低
ブラウザ(FILE/毎回手動操作)|高|低|低|高|底

## 開発順序

順|手法|セキュリティ|パフォーマンス|コスト|可動性|利便性|対象
--|----|------------|--------------|------|------|------|----
1|ブラウザ(FILE/毎回手動操作)|高|低|低|高|底|入門（概要把握）
2|ブラウザ(FILE/ハードコード)|中|低|中|高|低|活用（繰り返し使う）
3|ブラウザ(HTTPS/保存機構使用)|低|低|高|高|高|危険公開（リスク承知で利便性を優先）
4|Electron|中|低|高|中|高|PC安全公開（スマホ犠牲）
5|ネイティブ|高|高|頂|低|頂|PC最安全公開（CPUやOSなど稼働条件が厳しくなる）

1. セキュリティと可動性を最優先する。誰でも安全に使えること
2. セキュリティを犠牲にして利便性を優先する
3. 開発コストを犠牲にしてセキュリティと利便性を追求する

　3ブラウザ(HTTPS/保存機構使用)については、保存機構を使うか、それともファイル保存にするか、ユーザが任意に選択できるようにすると良い。利便性とセキュリティのトレードオフをユーザに委ねる形だ。デフォルト設定を変更すると利便性もあがる。

