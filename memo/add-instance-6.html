<script src="../docs/lib/van/1.2.6/nomodule.min.js"></script>
<script src="../docs/lib/van-x/0.1.3/nomodule.min.js"></script>
<script src="../docs/lib/js-yaml/4.1.0/min.js"></script>
<script src="../docs/lib/dexie/3.2.4/min.js"></script>
<script src="../docs/lib/util/type.js"></script>
<script>
const {div,span,h1,h2,p,br,em,ruby,rt,rp,textarea,button,input,table,tr,th,td,pre} = van.tags
window.addEventListener('DOMContentLoaded', async(event) => {
//    const InstanceList = () => {
    const InstanceList = (sname, initValues, addFn) => {
        //const items = vanX.reactive(JSON.parse(localStorage.getItem("appState") ?? "[]"))
        //const items = vanX.reactive([{domain:'mstdn.jp', isDel:false}])
        //const items = vanX.reactive([{domain:'mstdn.jp', isDel:false}])
        const items = vanX.reactive(((initValues) ? initValues.map(init=>({domain:init, isDel:false})) : [{domain:'mstdn.jp', isDel:false}]))
        //van.derive(() => localStorage.setItem("appState", JSON.stringify(items.filter(_ => 1))))
        const inputDom = input({id:`add-ins-${sname.toLowerCase()}`, type:'text',placeholder:'domain',size:6})
        const isValid = ()=>{
            console.log(inputDom.value, items)
            if (!inputDom.value.trim()) { console.warn('Á©∫ÂÄ§„Åß„Åô„ÄÇ'); return false; } // Á©∫ÂÄ§
            if (0 < WebService.ITEMS.filter(item=>item.name===sname)[0].instances.filter(ins=>ins.domain===inputDom.value).length) { console.warn('Êó¢Â≠ò„Åß„Åô„ÄÇ'); return false; } // Êó¢Â≠ò
            //if (0 < items.filter(item=>item.domain===inputDom.value).length) { console.warn('Êó¢Â≠ò„Åß„Åô„ÄÇ'); return false; } // Êó¢Â≠ò
            // „É™„É≥„ÇØÂàá„ÇåÁ¢∫Ë™ç„ÇÇ„Åó„Åü„ÅÑ„ÅåCORSÂà∂Á¥Ñ„Å´„Çà„Çä‰∏çÂèØËÉΩ‚Ä¶
            // „Éï„Ç©„Éº„Ç´„Çπ„Çª„ÉÉ„Éà
            return true
        }
        const addValue = ()=> {if (isValid()) {items.push({domain: inputDom.value, isDel: false}); addFn(inputDom.value); return true}}
        //const addValue = ()=> {if (isValid()) {items.push({domain: inputDom.value, isDel: false}); WebService.addInstance(sname, domain); }}
        const focus = ()=> {
            const si = WebService.ITEMS.findIndex(item=>item.name===sname)
            const s = WebService.ITEMS[si]
            if (!s.hasOwnProperty('instances')) { return }
            const ii = s.instances.findIndex(ins=>ins.domain===inputDom.value)
            console.log(`#webservice-${si}-${ii}`)
            setTimeout(()=>document.querySelector(`#webservice-${si}-${ii}`).focus(), 0)
        }
        //return div(inputDom,button({onclick:()=>addValue()}, 'Ôºã'))
        //return div(inputDom,button({onclick:()=>{addValue();focus();}}, 'Ôºã'))
        return div(inputDom,button({onclick:()=>{if(addValue()){focus()}}}, 'Ôºã'))
    }
//    van.add(document.body, InstanceList(['pawoo.net'], (domain)=>console.log(`${domain}ËøΩÂä†`)))
//    van.add(document.body, InstanceList(['misskey.com'], (domain)=>console.log(`${domain}ËøΩÂä†„Å†„Éº„Çà`)))

    /*
    van.add(document.body, InstanceList('Mastodon', ['pawoo.net'], (domain)=>{WebService.addInstance('Mastodon', domain);console.log(WebService.getService('Mastodon').instances);}))
    van.add(document.body, InstanceList('Misskey', ['misskey.com'], (domain)=>{WebService.addInstance('Misskey', domain);console.log(WebService.getService('Misskey').instances);}))
    */

;
//    van.add(document.body, InstanceList)

/*
    function makeInstanceList(initValues) {
        //const items = vanX.reactive([{domain:'mstdn.jp', isDel:false}])
        const items = vanX.reactive(((initValues) ? initValues.map(init=>({domain:init, isDel:false})) : [{domain:'mstdn.jp', isDel:false}]))
        const inputDom = input({type:'text',placeholder:'domain'})
        const isValid = ()=>{
            console.log(inputDom.value, items)
            if (!inputDom.value.trim()) { console.warn('Á©∫ÂÄ§„Åß„Åô„ÄÇ'); return false; } // Á©∫ÂÄ§
            if (0 < items.filter(item=>item.domain===inputDom.value).length) { console.warn('Êó¢Â≠ò„Åß„Åô„ÄÇ'); return false; } // Êó¢Â≠ò
            // „É™„É≥„ÇØÂàá„ÇåÁ¢∫Ë™ç„ÇÇ„Åó„Åü„ÅÑ„ÅåCORSÂà∂Á¥Ñ„Å´„Çà„Çä‰∏çÂèØËÉΩ‚Ä¶
            return true
        }
        const addValue = ()=> {if (isValid()) {items.push({domain: inputDom.value, isDel: false})}}
        const swap = (i, k)=> {
            const tmp = items[k]
            items[k] = items[i]
            items[i] = tmp
        }
        return div(inputDom,
            button({onclick:()=>addValue()}, 'Ôºã'),
            vanX.list(div, items, ({val: v}, deleter) => div(
                input({type: 'checkbox', checked: () => v.isDel, onclick: e => v.isDel = e.target.checked}),
                () => (v.isDel ? van.tags.strike : span)(v.domain),
                van.tags.a({href:()=>`https://${v.domain}/`,style:'text-decoration:none;'}, 'üîó'),
                van.tags.a({onclick:deleter, style:'cursor:pointer;'}, '‚ùå'),
            )),
        )
    }
//    van.add(document.body, makeInstanceList())
//    van.add(document.body, makeInstanceList('misskey.com'))
//    van.add(document.body, ()=>makeInstanceList())
//    van.add(document.body, ()=>makeInstanceList(['misskey.com']))
    */









    class AuthorState {
        constructor() {
            this.name = van.state('')
            this.cryptos = CryptoAssets.reactive()
            this.services = WebService.reactive()
            console.log(this.cryptos)
            console.log(this.services)
//            this.dates = dates
//            this.uuid = null
        }
        get htmls() { return [
            p(this.name),
            p(()=>div(this.services)),
            p(()=>div(this.cryptos)),
        ]}
        get yaml() { return jsyaml.dump({'author':{name:this.name.val, ...this.#webServiceYaml, ...this.#cryptoAssetsYaml}}) }
        get #webServiceYaml() { // ÂÄ§„Åå„ÅÇ„Çã„Ç≠„Éº„ÅÆ„ÅøÂØæË±°„Å´„Åó„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´‰Ωú„ÇäÁõ¥„Åô
            const obj = {}
            for (let key of Object.keys(this.services).sort()) {
                if      (''===this.services[key]) { continue }
                else if (Type.isString(this.services[key])) { obj[key] = this.services[key] }
                else if (Type.isObject(this.services[key])) {
                    obj[key] = {}
                    for (let insId of Object.keys(this.services[key])) {
                        if (this.services[key][insId]) {
                            obj[key][insId] = this.services[key][insId]
                        }
                    }
                    if (0===Object.keys(obj[key]).length) { delete obj[key] }
                }
            }
            return ((0===Object.keys(obj).length) ? ({}) : ({service:obj}))
        }
        get #copy() {
            const obj = {}
            JSON.parse(JSON.stringify(this.services))
        }
        get #cryptoAssetsYaml() {
            const obj = {}
            //for (let key of Object.keys(this.services)) {
            for (let key of Object.keys(this.cryptos).sort()) {
                if (this.cryptos[key]) { obj[key] = this.cryptos[key] }
            }
            return ((0===Object.keys(obj).length) ? ({}) : ({cryptos:obj}))
        }
    }
    /*
        class Domain {
            constructor(domain) {
                this._domain = domain
            }
            get domain() { return this._domain }
            get url() { return {
                top: `https://${this.domain}/`,
                userPage: `https://${this.domain}/`+'@{{account.name}}',
            }}
        }
    */
    class WebService {
        static ITEMS = vanX.reactive([
        //static ITEMS = [
            {index:0, category:'hosting', name:'GitHub', url:{domain:'github.com', top:'https://github.com/', userPage:`{{account.name}}`}},
            {index:1, category:'sns', name:'Mastodon', url:{wikipedia:'https://ja.wikipedia.org/wiki/%E3%83%9E%E3%82%B9%E3%83%88%E3%83%89%E3%83%B3_(%E3%83%9F%E3%83%8B%E3%83%96%E3%83%AD%E3%82%B0)'}, instances:[
                {index:0, domain:'mstdn.jp', top:'https://mstdn.jp/', userPage:`@{{account.name}}`},
                {index:1, domain:'mastodon-japan.net', top:'https://mastodon-japan.net/', userPage:`@{{account.name}}`},
            ]},
            {index:2, category:'sns', name:'Misskey', url:{wikipedia:'https://ja.wikipedia.org/wiki/Misskey'}, instances:[
                {index:0, domain:'nijimiss.moe', top:'https://nijimiss.moe/', userPage:`@{{account.name}}`},
                {index:1, domain:'misskey-square.net', top:'https://misskey-square.net/', userPage:`@{{account.name}}`},
            ]},
        //]
        ])
        //static getService(name) { return WebService.ITEMS.filter(item=>item.name.toLowerCase()===name.toLowerCase()) }
        static getService(name) { console.log(name, WebService.ITEMS[0].name);return WebService.ITEMS.filter(item=>item.name.toLowerCase()===name.toLowerCase())[0] }
        static getInstance(name, domain) { return this.getService(name).instances.filter(ins=>ins.domain===domain) }
        static addInstance(name, domain) { this.#addService(name); const s=this.getService(name); console.log(s, s.instances); return s.instances.push({'index':s.instances.length, 'domain':domain, 'top':`https://${domain}/`, 'userPage':`@{{account.name}}`, 'isDel':false}); }
        static #addService(name) { return this.ITEMS.push(({'index':this.ITEMS.length, 'name':name, 'category':'sns', 'url':{'wikipedia':''}, 'instances':[]})) }
        static deleteInstance(name, domain) {const s=this.getService(name); const i=s.instances.findIndex(ins=>ins.domain===domain); s.instances.splice(i, 1); console.log('deleteInstance', name, domain, i);}
        //static reactive() { // vanX.reactive({Service-Instance:User, ...})
        static reactive() { // vanX.reactive({Service:User, Service:{Instance:User,...}, ...})
            const obj = {}
            //const getKeys = (item)=>((item.hasOwnProperty('instances') ? item.instances.map(ins=>`${item.name}-${item.name}`) : [item.name]))
            const getKeys = (item)=>item.name
            const keys = this.ITEMS.map(item=>getKeys(item)).flat().map(k=>k.toLowerCase())
            console.log(keys)
//            for (let k of keys) { obj[k] = '' }
            for (let k of keys) {
                obj[k] = ''
                const conds = this.ITEMS.filter(item=>item.hasOwnProperty('instances') && k===item.name.toLowerCase())
                if (conds.length < 1) { continue }
                obj[k] = {}
                for (let ins of conds[0].instances) { Object.assign(obj[k], ({[ins.domain]: ''})) }
            }
            console.log(obj)
            return vanX.reactive(obj)
        }
        static make(meta) { return table(this.#trs(meta)) }
        static #trs(meta) { return WebService.ITEMS.map((item,i)=>((item.hasOwnProperty('instances')) ? this.#hasInstanceTrs(meta,item, i) : this.#tr(meta,item, i))) }
        static #tr(meta,item, i) { return [
            th({colspan:2},van.tags.label(van.tags.a({href:item.url.top, target:'_blank', rel:'noopener noreferrer'}, item.name))), 
            td(van.tags.input({id:`webservice-${i}`, placeholder:'„É¶„Éº„Ç∂Âêç„ÇÑË≠òÂà•Â≠ê', oninput:(e)=>{
                const selecteds = WebService.ITEMS.filter(item=>i===item.index)
                console.log(selecteds)
                if (1!==selecteds.length) { console.warn('WebService„ÅÆ„Ç≠„ÉºÂÄôË£ú„Åå1„Å§‰ª•Â§ñ„Åß‰∏çÊ≠£„Å™„ÅÆ„Åß‰∏≠Êñ≠„Åó„Åæ„Åô„ÄÇ'); }
//                const key = selecteds[0].name.toLowerCase()
                const key = this.#yamlKey(selecteds[0])
                console.log(`key: ${key}`)
                meta.author.services[key] = e.target.value
                console.log(`${key}: ${meta.author.services[key]}`)
            }}))
        ]}
        static #hasInstanceTrs(meta,item,i) { return item.instances.map((ins,k)=>tr(this.#instanceTrContents(meta,item,i,ins,k))) }
        /*
        static #hasInstanceTrs(meta,item,i) { return [...item.instances.map((ins,k)=>tr(this.#instanceTrContents(meta,item,i,ins,k))),
            tr(td(
                InstanceList(...(('Mastodon'===item.name) ? ['Mastodon', [], (domain)=>{WebService.addInstance('Mastodon', domain);console.log(WebService.getService('Mastodon').instances);}] : ['Misskey', [], (domain)=>{WebService.addInstance('Misskey', domain);console.log(WebService.getService('Misskey').instances);}])),
//                van.tags.label(van.tags.a({href:ins.top, target:'_blank', rel:'noopener noreferrer'}, ins.domain)), 
//                ((ins.hasOwnProperty('isDel')) ? van.tags.a({onclick:()=>{console.log('DEL');ins.isDel=true;}}, '‚úñ') : '')
            ),td())
        ] }
        */
        static #instanceTrContents(meta, item, i, ins, k) {
            const contens = []
            //if (0===k) { contens.push(th({rowspan:item.instances.length},van.tags.label(van.tags.a({href:item.url.wikipedia, target:'_blank', rel:'noopener noreferrer'}, item.name)))) }
            if (0===k) {
                //contens.push(th({rowspan:item.instances.length+1},
                contens.push(th({rowspan:item.instances.length},
                    van.tags.label(van.tags.a({href:item.url.wikipedia, target:'_blank', rel:'noopener noreferrer'}, item.name)),
                    van.tags.br(),
                    InstanceList(...(('Mastodon'===item.name) ? ['Mastodon', [], (domain)=>{WebService.addInstance('Mastodon', domain);console.log(WebService.getService('Mastodon').instances);}] : ['Misskey', [], (domain)=>{WebService.addInstance('Misskey', domain);console.log(WebService.getService('Misskey').instances);}])),
                ))
            }
            if (ins.isDel) { return contens }
            //contens.push(th(van.tags.label(van.tags.a({href:ins.top, target:'_blank', rel:'noopener noreferrer'}, ins.domain))))
            contens.push(th(
                van.tags.label(van.tags.a({href:ins.top, target:'_blank', rel:'noopener noreferrer'}, ins.domain)), 
                ((ins.hasOwnProperty('isDel')) ? van.tags.a({
                    onclick:()=>{console.log('DEL');ins.isDel=true;this.deleteInstance(item.name, ins.domain);setTimeout(()=>document.querySelector(`#add-ins-${item.name.toLowerCase()}`).focus(), 0);},
                    onkeydown:e=>{if(' '===e.key){e.preventDefault()}else if('Tab'===e.key){return}ins.isDel=true;this.deleteInstance(item.name, ins.domain);console.log('aXXXXXXXXX');setTimeout(()=>document.querySelector(`#add-ins-${item.name.toLowerCase()}`).focus(), 0);},tabindex:0}, '‚úñ') : '')))
            contens.push(td(van.tags.input({id:`webservice-${i}-${k}`, placeholder:'„É¶„Éº„Ç∂Âêç„ÇÑË≠òÂà•Â≠ê', oninput:(e)=>{
                    const selected = WebService.ITEMS.filter(item=>i===item.index)[0]
                    const serviceId = selected.name.toLowerCase()
                    const instanceId = selected.instances[k].domain.toLowerCase()
                    meta.author.services[`${serviceId}`][`${instanceId}`] = e.target.value;
                    console.log(e,e.target.value,i,serviceId,instanceId,meta.author.services[`${serviceId}`][`${instanceId}`]);
                    
//            }}, ((ins.hasOwnProperty('isDel')) ? van.tags.a({onclick:()=>ins.isDel}, '‚úñ') : ''))))
            }})))
//            console.log('xxxxxxxxxxxxxxxxxxxxxx:', ins, ins.hasOwnProperty('isDel'), ((ins.hasOwnProperty('isDel')) ? van.tags.a({onclick:()=>ins.isDel}, '‚úñ') : ''))
            return contens
       }
       static #yamlKey(service, instance) { return `${service.name}${((instance) ? '-'+instance.domain.replace('.','-') : '')}`.toLowerCase() }
    }
    class CryptoAssets {
        static ITEMS = [
            {index:0, abbr:'MONA', url:'https://ja.wikipedia.org/wiki/Monacoin'},
            {index:1, abbr:'BTC', url:'https://ja.wikipedia.org/wiki/%E3%83%93%E3%83%83%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3'},
            {index:2, abbr:'LTC', url:'https://ja.wikipedia.org/wiki/%E3%83%A9%E3%82%A4%E3%83%88%E3%82%B3%E3%82%A4%E3%83%B3'},
            {index:3, abbr:'ETH', url:'https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%BC%E3%82%B5%E3%83%AA%E3%82%A2%E3%83%A0'},
            {index:4, abbr:'SOL', url:'https://en.wikipedia.org/wiki/Solana_(blockchain_platform)'},
            {index:5, abbr:'DOGE', url:'https://ja.wikipedia.org/wiki/%E3%83%89%E3%83%BC%E3%82%B8%E3%82%B3%E3%82%A4%E3%83%B3'},
        ]
        constructor(type, address) {
            this.type = type
            this.address = address
        }
        static make(meta) { return table(this.#trs(meta)) }
        static #trs(meta) { return this.ITEMS.map((item,i)=>tr(
            th(van.tags.label(van.tags.a({href:item.url, target:'_blank', rel:'noopener noreferrer'}, item.abbr))), 
            //td(van.tags.input({id:`crypto-assets-${i}`, placeholder:'„Ç¢„Éâ„É¨„Çπ', oninput:(e)=>meta.author.cryptoAssets[i].address.val = e.target.value}))
            td(van.tags.input({id:`crypto-assets-${i}`, placeholder:'„Ç¢„Éâ„É¨„Çπ', oninput:(e)=>{
                console.log(meta.author.cryptoAssets)
                meta.author.cryptos[item.abbr.toLowerCase()] = e.target.value
            }}))
        ))}
        static reactive() { // vanX.reactive({Abbr:Address, ...})
            const obj = {}
            for (let item of this.ITEMS) { obj[item.abbr] = '' }
            return vanX.reactive(obj)
        }
    }
    class Dates {
        constructor(created, published, updated, expiration) {
            this.created = ((created) ? created : new Date())
            this.published = published
            this.updated = updated
            this.expiration = expiration
        }
        ymdhms(d,s1='-',s2=' ',s3=':') { return `${this.ymd(d, s1)}${s2}${this.hms(d, s3)}` }
        ymd(d,s='-') { return `${d.getFullYear()}${s}${d.getMonth()+1}${s}${d.getDate()}` }
        hms(d,s=':') { return `${d.getHours()}${s}${d.getMinutes()}${s}${d.getSeconds()}` }
        md(d,s='-') { return `${d.getMonth()+1}${s}${d.getDate()}` }
        hm(d,s=':') { return `${d.getHours()}${s}${d.getMinutes()}${s}${d.getSeconds()}` }
        ms(d,s=':') { return `${d.getHours()}${s}${d.getMinutes()}${s}${d.getSeconds()}` }
    }
    class Revision {
        constructor(ver, created, patch, summary) {
            this.version = ver
            this.created = created
            this.patch = patch
            this.summary = summary
        }
    }
    class SelectElement {
        constructor(label, items, setFn, selectedIndex=0) {
            this._label = label
            this._items = items
            this._setFn = setFn
            this._selected = van.state(selectedIndex)
            this._summary = van.derive(()=>this._items[this._selected.val].summary)
            this._comment = van.derive(()=>this._items[this._selected.val].comment)
            this._details = van.derive(()=>this._items[this._selected.val].details)
        }
        get label() { return this._label }
        make(meta) { return div(van.tags.select({title:()=>this._comment.val, onchange:(e)=>{
            console.log(this._selected.val);
            this._selected.val = e.target.value
            this._setFn(meta, this.selectedItem) // meta.genre = this.selectedItem.name
        //}}, this.#options), span(this._summary)) }
        }}, this.#options), van.tags.details({style:'display:inline-block;'},van.tags.summary(this._summary), this._details)) }
        get #options() { return this._items.map((item,i)=>van.tags.option({title:item.summary, value:i}, item.name)) }
        get selectedItem() { return this._items[this._selected.val] }
    }
    const Category = new SelectElement('„Ç´„ÉÜ„Ç¥„É™', [
        {name: 'ÊñáÂ≠¶', summary:'‰∫∫Èñì„ÅÆÈÜú„Åï„ÇÑÊÇ≤Âäá„ÇíÊèè„ÅÑ„ÅüÂ∞èË™¨„ÄÇ', comment:'Ëä∏Ë°ìÊÄß„ÇíÈáçË¶ñ', details:'Á¥îÊñáÂ≠¶„ÄÇÂ≠¶Âïè„Åß„Å™„ÅÑÊï£Êñá„Åß„ÄÅËä∏Ë°ìÊÄß„ÅÆ„ÅÇ„ÇãÊñáÁ´†„ÄÇ'},
        {name: '‰∏ÄËà¨ÊñáËä∏', summary:'Áâ©Ë™û„ÅÆÈù¢ÁôΩ„Åï„ÇíËøΩÊ±Ç„Åó„ÅüÂ∞èË™¨„ÄÇ', comment:'Â®ØÊ•ΩÊÄß„ÇíÈáçË¶ñ', details:'Â§ßË°ÜÊñáÂ≠¶„ÄÇÊñáÂ≠¶„Çà„Çä„ÇÇÂ®ØÊ•ΩÊÄß„ÇíÈáçË¶ñ„Åó„ÅüÊñáÁ´†„ÄÇ'},
        {name: '„É©„Ç§„ÉàÊñáËä∏', summary:'ÁèæÂÆüÂë≥„ÅÆ„ÅÇ„Çã„É©„Ç§„Éà„Éé„Éô„É´Â∞èË™¨„ÄÇ', comment:'Â§ß‰∫∫Áî®„É©„Éé„Éô', details:'Â§ß‰∫∫Áî®„É©„Éé„Éô„ÄÇ‰∏ÄËà¨ÊñáËä∏Ôºã„É©„Ç§„Éà„Éé„Éô„É´„ÄÇ„É©„Éé„Éô„Å®ÂêåÊßò„Å´„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂ£≤„Çä„Å´„Åó„Å§„Å§„ÄÅ„Çà„ÇäÁèæÂÆüÂë≥„Åå„ÅÇ„ÇãÊñáÁ´†„ÄÇ'},
        {name: '„É©„Ç§„Éà„Éé„Éô„É´', summary:'ÁôªÂ†¥‰∫∫Áâ©„ÅÆÈù¢ÁôΩ„Åï„ÇíËøΩÊ±Ç„Åó„ÅüÂ∞èË™¨„ÄÇ', comment:'ÊÄùÊò•ÊúüÂêë„Åë„ÄÇÈùûÁèæÂÆüÁöÑ„Å™Ë®≠ÂÆö„ÄÇÂπ≥Êòì„Å™Êñá‰Ωì„ÄÇ', details:'ÊÄùÊò•ÊúüÂêë„Åë„ÄÇÈùûÁèæÂÆüÁöÑ„Å™Ë®≠ÂÆö„ÄÇÂπ≥Êòì„Å™Êñá‰Ωì„ÄÇ„Éè„ÉÉ„Éî„Éº„Ç®„É≥„Éâ„ÄÇÂ§öÂπ∏ÊÑü„ÄÇ„Çπ„Éà„É¨„Çπ„Éï„É™„Éº„ÄÇÈ†≠„ÇíÁ©∫„Å£„ÅΩ„Å´„Åó„Å¶„Çπ„É©„Çπ„É©Ë™≠„ÇÅ„Çã„ÄÇ‰∏çÂø´„Å™Â±ïÈñã„Åå„Å™„ÅèÂø´ÊÑü„Å∞„Åã„Çä„ÄÇ'},
        {name: 'ÂÖêÁ´•', summary:'12Ê≠≥‰ª•‰∏ã„ÅÆÂÖêÁ´•Âêë„ÅëÂ∞èË™¨„ÄÇ', comment:'Â≠ê‰æõÁî®Â∞èË™¨', details:''},
    ], (meta,item)=>meta.category=item.name)
    const Genre = new SelectElement('„Ç∏„É£„É≥„É´', [
        {name: '„Éï„Ç°„É≥„Çø„Ç∏„Éº', summary:'Ââ£„ÉªÈ≠îÊ≥ï„Éª„Éâ„É©„Ç¥„É≥Á≠â„ÅåÂ≠òÂú®„Åô„Çã‰∏ñÁïå„Åß„ÅÆÂÜíÈô∫Ë≠ö„ÄÇ', comment: '', details:''},
        {name: 'SF', summary:'ÁßëÂ≠¶ÁöÑÊ†πÊã†„Çí„Éô„Éº„Çπ„Å´„Åó„ÅüÁâ©Ë™û„ÄÇ', comment: 'Ë™∞„ÅåÁäØ‰∫∫„Åã„ÄÅ„Å©„Çì„Å™ÊâãÂè£„Åã„ÄÅÂãïÊ©ü„ÅØ‰Ωï„Åã„ÄÇ', details:''},
        {name: 'Êé®ÁêÜ', summary:'Ë¨éËß£„Åç„Åå‰∏ªÈ°å„ÅÆÂ∞èË™¨„ÄÇ', comment: '', details:''},
        {name: '„Éõ„É©„Éº', summary:'ÊÅêÊÄñ„Åå‰∏ªÈ°å„ÅÆÂ∞èË™¨„ÄÇ', comment: 'ÊÄ™Ë´á„ÄÅÂπΩÈúä„ÄÅÂ¶ñÊÄ™„ÄÅÂë™„ÅÑ„ÄÅ„Çæ„É≥„Éì„ÄÅ„Ç¶„Ç§„É´„Çπ„ÄÅ„Éë„Éã„ÉÉ„ÇØ', details:''},
        {name: 'ÊÅãÊÑõ', summary:'ÊÅãÊÑõ„Çí‰∏ªËª∏„Å´„Åä„ÅÑ„ÅüÁâ©Ë™û„ÄÇ', comment: '', details:''},
        {name: 'ÈùíÊò•', summary:'Â≠¶Áîü„Åå‰∏ª‰∫∫ÂÖ¨„ÅÆÁâ©Ë™û„ÄÇ', comment: '', details:''},
        {name: 'Ê≠¥Âè≤/ÊôÇ‰ª£', summary:'Ê≠¥Âè≤„ÇíÁâ©Ë™û„Å´„Åó„ÅüÂ∞èË™¨„ÄÇ', comment: 'Âè≤ÂÆü‚Üí"Ê≠¥Âè≤"ÔºèÂâµ‰Ωú‚Üí"ÊôÇ‰ª£"', details:''},
        {name: 'ÁµåÊ∏à', summary:'ÁµåÊ∏à„ÅÆ‰ªïÁµÑ„Åø„ÇÑÂä¥ÂÉçÂïèÈ°å„ÇíÊâ±„ÅÜÁâ©Ë™û„ÄÇ', comment: '', details:''},
        {name: 'ÊîøÊ≤ª', summary:'ÊîøÊ≤ªÁöÑÂá∫Êù•‰∫ã„ÇíÊâ±„Å£„ÅüÁâ©Ë™û„ÄÇ', comment: '', details:''},
        {name: 'ÂÆòËÉΩ', summary:'ÊÄßÊèèÂÜô„Åå‰∏ªÈ°å„ÅÆÂ∞èË™¨„ÄÇ', comment: '', details:''},
        {name: '„Éé„É≥„Éï„Ç£„ÇØ„Ç∑„Éß„É≥', summary:'‰∫ãÂÆü„Å´Âü∫„Å•„ÅÑ„ÅüÁâ©Ë™û„ÄÇ', comment: '', details:''},
        {name: 'ÈöèÁ≠Ü', summary:'Ë¶ãËÅû„ÉªÊÄùÁ¥¢„ÉªÊÑüÊÉ≥„Å™„Å©„ÇíÊ∞ó„Åæ„Åæ„Å´Ë®ò„Åó„ÅüÊñáÁ´†„ÄÇ', comment: '„Ç®„ÉÉ„Çª„Ç§„ÄÅÊó•Ë®ò„ÄÅÈõëË®ò„ÄÅÁßÅÂ∞èË™¨', details:'Ë©±„ÅÆÁ≠ãÈÅì„ÅåÊï¥ÂêàÁöÑ„Å™‰ΩìÁ≥ª„Å´ÂõûÂèé„Åï„Çå„Å¶„Åó„Åæ„ÅÜ„Åì„Å®„Çí‰Ωï„Çà„ÇäÂøåÈÅø„Åó„Å¶„ÄÅË§áÊï∞„ÅÆË´ñÁêÜ„ÇÑÊñ≠ÁâáÁöÑ„Å™ÊÄùËÄÉ„Å´Á©çÊ•µÁöÑ„Å´Ë∫´„Çí‰ªª„Åõ„ÄÅËÑ±Á∑ö„ÇÑÈÄ∏ËÑ±„ÇÑÈÄ°Â∑°„Çí„ÅÑ„Å®„Çè„Å™„ÅÑ„ÄÇÂÆâÁõ¥„Å™ÂÖ®‰ΩìÂåñ„Å´Âü∑Êãó„Å´ÊäµÊäó„Åô„Çã„ÄÅ„Åù„Çì„Å™Ëá™Áî±„Å™ÊÄùËÄÉ„ÅÆ„ÄåË©¶„Åø„Äç„Å´„Åì„Åù„ÄÅ„Ç®„ÉÉ„Çª„Ç§„Å®„ÅÑ„ÅÜ„Ç∏„É£„É≥„É´„ÅÆÊú¨Ë≥™„Åå„ÅÇ„Çã„ÄÇ'},
    ], (meta,item)=>meta.genre=item.name)

    console.log(CryptoAssets.ITEMS)
    class WorkState {
        constructor(title, catchCopy, intro, category, genre) {
            this.title = title
            this.catch = catchCopy
            this.intro = intro
            this.category = category // Â∞èË™¨ÔºàÊñáÂ≠¶„ÄÅ‰∏ÄËà¨ÊñáËä∏„ÄÅ„É©„Ç§„ÉàÊñáËä∏„ÄÅ„É©„Ç§„Éà„Éé„Éô„É´„ÄÅÂÖêÁ´•Ôºâ
            this.genre = genre // „Éï„Ç°„É≥„Çø„Ç∏„Éº„ÄÅSF„ÄÅÊé®ÁêÜ„ÄÅ„Éõ„É©„Éº„ÄÅÊÅãÊÑõ„ÄÅÈùíÊò•„ÄÅÊ≠¥Âè≤„ÄÅÁµåÊ∏à„ÄÅÊîøÊ≤ª„ÄÅÂÆòËÉΩ„ÄÅÈöèÁ≠Ü„ÄÅ„Éé„É≥„Éï„Ç£„ÇØ„Ç∑„Éß„É≥
        }
        get htmls() { return [
            h1(this.title),
            h2(this.catch),
            p(this.category),
            p(this.genre),
        ]}
        get yaml() { return jsyaml.dump({title:this.title, catch:this.catch, intro:this.intro, category:this.category, genre:this.genre}) }
        //get yaml() { return jsyaml.dump({title:this.title, catch:this.catch, intro:this.intro, category:this.category, genre:this.genre, author:{'name':this.author.name }}) }
    }
    class Meta {
        constructor(title, catchCopy, intro, category, genre) {
            this.work = vanX.reactive(new WorkState(title, catchCopy, intro, category, genre))
            this.author = new AuthorState()
//            this.cryptos = CryptoAssets.reactive()
//            this.services = WebService.reactive()
        }
        get htmls() { return [
            h1(this.work.title),
            h2(this.work.catch),
            p(this.work.intro),
            p(this.work.category),
            p(this.work.genre),
            p(this.author.name),
            p(Object.entries(this.author.services).join(',')),
            p(Object.entries(this.author.cryptos).join(',')),
//            p(()=>div(this.author.webServices.map((item,i)=>`${WebService.ITEMS[i].name}:${item.username.val}`))),
//            p(()=>div(this.author.cryptoAssets.map((item,i)=>`${CryptoAssets.ITEMS[i].abbr}:${item.address.val}`))),
        ]}
        //get yaml() { return `---\n${jsyaml.dump({title:this.title, catch:this.catch, intro:this.intro, category:this.category, genre:this.genre, author:{'name':this.author.name }})}---` }
        get yaml() { return `---\n${this.work.yaml}${this.author.yaml}---` }
        get #webServiceYaml() { return this.author.webServices.filter(item=>item.username.val).map(item=>{
            console.log(item);
            return ({'type':WebService.ITEMS[item.index].name, 'address':item.username.val});
        }) }
    }
    const meta = new Meta('„Çø„Ç§„Éà„É´', '„Ç≠„É£„ÉÉ„ÉÅ„Ç≥„Éî„Éº', 'Á¥π‰ªãÊñá', Category.selectedItem.name, Genre.selectedItem.name)
    console.log(Object.keys(meta))
    console.log(Object.getOwnPropertyDescriptor(meta, "property"))
    van.add(document.body, div(div(table(
        tr(th('„Çø„Ç§„Éà„É´'), td(input({placeholder:'„Çø„Ç§„Éà„É´',value:'„Çø„Ç§„Éà„É´',oninput:(e)=>meta.work.title=e.target.value}))), 
        tr(th('ÔΩ∑ÔΩ¨ÔΩØÔæÅÔΩ∫ÔæãÔæüÔΩ∞'), td(input({placeholder:'„Ç≠„É£„ÉÉ„ÉÅ„Ç≥„Éî„Éº',value:'„Ç≠„É£„ÉÉ„ÉÅ„Ç≥„Éî„Éº',oninput:(e)=>meta.work.catch=e.target.value}))), 
        tr(th('Á¥π‰ªãÊñá'), td(input({placeholder:'Á¥π‰ªãÊñá',value:'Á¥π‰ªãÊñá',oninput:(e)=>meta.work.intro=e.target.value}))), 
        tr(th(Category.label), td(()=>Category.make(meta.work))), 
        tr(th(Genre.label), td(()=>Genre.make(meta.work))), 
    //)), div(()=>div(meta.htmls)), pre(()=>meta.yaml)))
    ))))
    van.add(document.body, div(div(table(
        tr(th('ËëóËÄÖÂêç'), td(input({id:`author-name`,placeholder:'Â±±Áî∞„Ää„ÇÑ„Åæ„Å†„ÄãÂ§™ÈÉé„Ää„Åü„Çç„ÅÜ„Äã',value:'Â±±Áî∞„Ää„ÇÑ„Åæ„Å†„ÄãÂ§™ÈÉé„Ää„Åü„Çç„ÅÜ„Äã',oninput:(e)=>meta.author.name.val=e.target.value}))), 
//        tr(th('Â§ñÈÉ®'), td(WebService.make(meta.author))),
//        tr(th('ÊöóÂè∑ÈÄöË≤®'), td(CryptoAssets.make(meta.author))), 
//        tr(th('Â§ñÈÉ®'), td(WebService.make(meta))),
//        tr(th('ÊöóÂè∑ÈÄöË≤®'), td(CryptoAssets.make(meta))), 
        tr(th('Â§ñÈÉ®'), td(()=>WebService.make(meta))),
        tr(th('ÊöóÂè∑ÈÄöË≤®'), td(()=>CryptoAssets.make(meta))), 
    //)), div(()=>div(meta.author.htmls)), pre(()=>meta.author.yaml)))
    ))))
    van.add(document.body, button({id:'save', onclick:async(e)=>{
        const db = new Dexie('JavelDb');
        db.version(1).stores({
            authors: '++id,name,services,cryptos',
            works: '++id,authorId,title,catch,intro,category,genre,body',
        });
        //const author = await db.authors.toArray()
        //const authors = await db.authors.toArray()
        //const author = authors[0]
        //const author = (await db.authors.toArray())[0]
        const author = await db.authors.get(0)
        console.log(author)
        console.log(author.name)
        console.log(document.querySelector('#author-name').value)
        console.log(author.name===document.querySelector('#author-name').value)
        if (author.name===document.querySelector('#author-name').value) { console.warn('‰øùÂ≠ò„Éá„Éº„Çø„Å®ÂÆåÂÖ®‰∏ÄËá¥„ÅÆ„Åü„ÇÅ‰øùÂ≠ò‰∏≠Ê≠¢„Åó„Åæ„Åô„ÄÇ'); return; }
        db.authors.put({
            id:0,
            name:document.querySelector('#author-name').value,
        })
        /*
        console.log(db.authors.get())
        console.log(db.authors.toArray())
        console.log(db.authors.toArray()._value)
        console.log(db.authors.toArray().then((authors)=>console.log(authors)))

        console.log(db.authors.first())
        for (let record of db.authors.toArray()) { console.log(record) }
        let data = await db.authors.get()
        console.log(data)
        data = await db.authors.toArray()
        console.log(data)
        */
        /*
        db.authors.put({
            id:0,
            name:document.querySelector('#author-name'),
        })
        console.log(db.authors.toArray())
        */
    }}, '‰øùÂ≠ò'))
    van.add(document.body, div(()=>div(meta.htmls)), pre(()=>meta.yaml))

    static getDb
    const services = WebService.ITEMS.filter(item=>item.hasOwnProperty('instances'))
    const objs = services.map(s=>({[s.name]:s.instances.map(ins=>({domain:ins.domain, username:ins.username}))}))
    {
        'mastodon': [{domain:'', username:''}, 'misskey':[]]
    }
    document.querySelectorAll(`input[id^='webservice-']`)
})
</script>

